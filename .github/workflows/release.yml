name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            name: ratunit-aarch64-apple-darwin
          - target: x86_64-apple-darwin
            os: macos-latest
            name: ratunit-x86_64-apple-darwin
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: ratunit-x86_64-unknown-linux-gnu
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal
          rustup target add ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} -p ratunit

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/ratunit dist/
          cd dist
          tar czf ${{ matrix.name }}.tar.gz ratunit
          shasum -a 256 ${{ matrix.name }}.tar.gz > ${{ matrix.name }}.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist/${{ matrix.name }}.tar.gz*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true

  update-tap:
    needs: release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS ARM artifact
        uses: actions/download-artifact@v4
        with:
          name: ratunit-aarch64-apple-darwin
          path: artifacts

      - name: Download macOS x86 artifact
        uses: actions/download-artifact@v4
        with:
          name: ratunit-x86_64-apple-darwin
          path: artifacts

      - name: Update Homebrew formula
        env:
          TAP_TOKEN: ${{ secrets.TAP_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SHA_ARM=$(shasum -a 256 artifacts/ratunit-aarch64-apple-darwin.tar.gz | cut -d' ' -f1)
          SHA_X86=$(shasum -a 256 artifacts/ratunit-x86_64-apple-darwin.tar.gz | cut -d' ' -f1)
          TAG="${GITHUB_REF_NAME}"

          cat > formula.rb << FORMULA
          class Ratunit < Formula
            desc "A rat-powered TUI for viewing JUnit XML test reports"
            homepage "https://github.com/rupert648/ratunit"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/rupert648/ratunit/releases/download/${TAG}/ratunit-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_ARM}"
              else
                url "https://github.com/rupert648/ratunit/releases/download/${TAG}/ratunit-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_X86}"
              end
            end

            def install
              bin.install "ratunit"
            end

            test do
              assert_match "ratunit", shell_output("#{bin}/ratunit --help")
            end
          end
          FORMULA

          # Remove leading whitespace from heredoc
          sed -i '' 's/^          //' formula.rb

          # Push to tap repo
          git clone https://x-access-token:${TAP_TOKEN}@github.com/rupert648/homebrew-tap.git tap
          cp formula.rb tap/Formula/ratunit.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/ratunit.rb
          git commit -m "Update ratunit to ${VERSION}"
          git push
